{% extends "base.html" %}

{% block title %}工具7：B站视频无水印下载 + 字幕提取{% endblock %}

{% block header %}B站视频无水印下载 + 字幕提取（支持自动字幕，免费无限制）{% endblock %}

{% block content %}
<style>
    .input-area { display: flex; gap: 15px; margin-bottom: 30px; align-items: center; }
    input { flex: 1; padding: 16px 20px; font-size: 16px; border: 2px solid #e1e5e9; border-radius: 12px; outline: none; transition: all 0.3s; }
    input:focus { border-color: #0066ff; box-shadow: 0 0 0 4px rgba(0,102,255,0.1); }
    button { padding: 16px 40px; background: #0066ff; color: white; border: none; border-radius: 12px; font-size: 18px; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 15px rgba(0,102,255,0.3); }
    button:hover { background: #0055cc; transform: translateY(-2px); }
    button:disabled { background: #999; cursor: not-allowed; }
    .video-container { text-align: center; margin: 40px 0; background: #000; border-radius: 16px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    video { max-width: 100%; max-height: 70vh; border-radius: 16px; }
    .download-group { text-align: center; margin: 30px 0; }
    .download-btn { display: inline-block; margin: 10px; padding: 14px 36px; background: #00c853; color: white; border-radius: 50px; font-size: 18px; text-decoration: none; box-shadow: 0 6px 20px rgba(0,200,83,0.4); transition: all 0.3s; }
    .download-btn:hover { background: #00b140; transform: translateY(-3px); }
    .subtitle-btn { background: #ff9800; box-shadow: 0 6px 20px rgba(255,152,0,0.4); }
    .subtitle-btn:hover { background: #f57c00; }
    .tips { background: #f0f8ff; padding: 20px; border-radius: 12px; border-left: 5px solid #0066ff; font-size: 15px; color: #555; margin-top: 40px; }
</style>

<div class="input-area">
    <input type="text" id="url" placeholder="粘贴B站视频链接（支持bv号、av号、share链接）">
    <input type="text" id="cookies_file" placeholder="Cookies 文件路径（如 cookies/bilibili/cookies.txt，可选）">
    <button id="download-btn" onclick="download()">开始下载</button>
</div>

<div id="result"></div>

<div class="tips">
    <strong>使用提示：</strong><br>
    • 支持B站所有公开视频（最高1080p原画质）<br>
    • 自动提取官方字幕 + 自动生成字幕（中文优先）<br>
    • 下载后自动播放 + 一键保存视频/字幕文件<br>
    • 完全免费，无限次使用，永不失效<br>
    <strong>Cookies 设置：</strong><br>
    • 如果视频字幕需要登录，请提供 Cookies 文件路径（如 cookies/bilibili/cookies.txt）<br>
    • 获取方法：登录 B 站，浏览器 F12 → Application → Cookies → 导出为 Netscape 格式
</div>

<script>
async function download() {
    const urlInput = document.getElementById('url');
    const btn = document.getElementById('download-btn');
    const url = urlInput.value.trim();
    if (!url) return alert('请先粘贴B站视频链接！');

    btn.disabled = true;
    btn.textContent = '解析中...';

    const result = document.getElementById('result');
    result.innerHTML = '<p style="text-align:center;color:#666;padding:40px;">解析中，请稍等（首次可能较慢）...</p>';

    const formData = new FormData();
    formData.append('url', url);
    const cookiesFile = document.getElementById('cookies_file').value.trim();
    if (cookiesFile) {
        formData.append('cookies_file', cookiesFile);
    }

    const res = await fetch('/api/bilibili', {
        method: 'POST',
        body: formData
    });
    const data = await res.json();

    if (data.success) {
        let html = `
            <div class="video-container">
                <video src="${data.video}" controls autoplay playsinline>
                    您的浏览器不支持视频播放
                </video>
            </div>
            <div class="download-group">
                <a href="${data.video}" download class="download-btn">
                    一键下载视频 MP4
                </a>`;
        if (data.subtitles && data.subtitles.length > 0) {
            html += `<div class="download-group">`;
            data.subtitles.forEach(sub => {
                html += `
                    <a href="${sub.url}" download class="download-btn subtitle-btn">
                        下载字幕: ${sub.lang}
                    </a>`;
            });
            html += `</div>`;
        }
        html += `
            </div>
            <p style="text-align:center;color:#00c853;font-size:18px;margin-top:20px;">
                下载成功！标题：${data.title}<br>
                字幕状态：${data.subtitle_status}
            </p>`;
        result.innerHTML = html;
    } else {
        result.innerHTML = `<p style="color:red;text-align:center;">${data.error}</p>`;
    }

    btn.disabled = false;
    btn.textContent = '开始下载';
}
</script>
{% endblock %}
